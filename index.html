<!DOCTYPE html>
<html lang="en" data-lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TRUE CAR RENTAL</title>

  <!-- SEO / Open Graph -->
  <meta name="description" content="Rent new cars in Dubai with full insurance, no deposit, and free delivery. Truecars.ae." />
  <link rel="canonical" href="https://truecars.ae/">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://truecars.ae/">
  <meta property="og:title" content="Truecars — Car Rental in Dubai">
  <meta property="og:description" content="Full insurance included. Free delivery across Dubai. No deposit.">
  <meta property="og:image" content="https://raw.githubusercontent.com/truecarsae/truecars-site/truecarsae-images/dubai-skyline.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://github.com/truecarsae/truecars-site/blob/truecarsae-images/favicon.png?raw=true">
  <link rel="apple-touch-icon" href="https://github.com/truecarsae/truecars-site/blob/truecarsae-images/favicon.png?raw=true">
  <meta name="theme-color" content="#1e1e1e">

  <link rel="preconnect" href="https://api.github.com" crossorigin>
  <link rel="preconnect" href="https://raw.githubusercontent.com" crossorigin>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;}
    html{scroll-behavior:smooth;}
    body{background-color:#3a3a3a;color:#fff;line-height:1.6;overflow-x:hidden;}
    body.no-scroll{overflow:hidden;touch-action:none;}
    a{text-decoration:none;color:inherit;}

    :root{
      --header-bg:#1e1e1e;
      --header-height:90px;
      --header-height-scrolled:60px;
      --bg-shift:0px;
      --danger:#ff3333;
      --muted:#bbb;
      --accent:#ffcc00;

      /* длительности анимаций модалки */
      --modal-fade: 280ms;
      --modal-scale: 220ms;
    }

    /* ===== Header ===== */
    header{
      position:fixed;top:0;left:0;width:100%;
      height:var(--header-height);
      background:var(--header-bg);
      display:flex;justify-content:center;align-items:center;
      padding-right:72px; /* резерв справа под EN|RU */
      transition:height .35s ease,box-shadow .35s ease;
      z-index:1000;
      box-shadow:0 2px 8px rgba(0,0,0,0.4);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    header.scrolled{height:var(--header-height-scrolled);}
    #main-logo{
      height:100%; width:auto; padding:0;
      transition:filter .35s ease;
      display:block; -webkit-user-drag:none;
    }
    header.scrolled #main-logo{filter:drop-shadow(0 0 4px rgba(0,0,0,.2));}
    #header-spacer{height:var(--header-height);transition:height .35s ease;}

    /* Language switcher */
    #lang-switch{
      position:absolute; right:16px; top:50%; transform:translateY(-50%);
      display:flex; align-items:center; gap:8px; user-select:none;
      pointer-events:auto;
    }
    .lang-btn{
      background:none; border:none; color:#aaa; font-weight:700; font-size:14px;
      cursor:pointer; padding:4px 6px; -webkit-tap-highlight-color: transparent;
    }
    .lang-btn.active{ color:var(--accent); }
    #lang-switch .sep{ color:#888; }

    /* ===== Hero (parallax) ===== */
    .hero{
      position:relative;min-height:56vh;overflow:hidden;
      display:flex;flex-direction:column;justify-content:center;align-items:center;
      text-align:center;padding:10px 18px 20px;
      background:linear-gradient(to bottom,rgba(0,0,0,0.5),#3a3a3a 75%);
    }
    .hero::before{
      content:"";position:absolute;top:0;left:0;width:100%;height:120%;
      background:url("https://github.com/truecarsae/truecars-site/blob/truecarsae-images/dubai-skyline.png?raw=true") center/cover no-repeat;
      transform:translateY(var(--bg-shift)); will-change:transform; z-index:-1;
      filter:brightness(0.9) contrast(1.1);
    }
    @media (max-height:700px){ .hero::before{height:100%;} }

    .hero h1{
      font-size:2.4rem;font-weight:800;letter-spacing:.5px;color:var(--accent);
      text-transform:uppercase;margin-bottom:10px;line-height:1.15;
    }
    .hero .subtitle{font-size:1.15rem;color:#e9e9e9;margin-bottom:6px;font-weight:500;line-height:1.35;}
    .hero .subtext{font-size:1.05rem;color:var(--accent);margin-bottom:4px;font-weight:700;line-height:1.3;}
    .hero .note{font-size:.98rem;color:#cfcfcf;margin-bottom:14px;line-height:1.3;font-weight:400;}
    .cta{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;align-items:center;text-align:center;margin-top:6px;}
    .cta a{background:#fff;color:#1c1c1c;padding:12px 20px;border-radius:6px;font-weight:700;transition:0.25s;}
    .cta a:hover{background:#ffcc00;color:#1c1c1c;transform:translateY(-1px);}

    /* ===== Cars ===== */
    .cars{padding:60px 20px;max-width:1200px;margin:-60px auto 0;}
    .cars h2{text-align:center;font-size:2.2rem;margin-bottom:32px;}
    .car-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:30px;}
    .car-card{background:#2a2a2a;border-radius:10px;padding:20px;text-align:center;transition:0.3s;cursor:pointer;}
    .car-card:hover{background:#333;transform:translateY(-5px);}
    .car-card img{
      max-width:100%;border-radius:10px;margin-bottom:15px;object-fit:cover;aspect-ratio:16/9;
      opacity:0;transition:opacity .45s ease;
    }
    .car-card img.img-loaded{opacity:1;}
    .car-card h3{font-size:1.5rem;margin-bottom:10px;}
    .car-card p{font-size:1rem;color:#ccc;}

    /* ===== Footer ===== */
    footer{text-align:center;padding:40px 20px;background:#111;color:#aaa;margin-top:40px;}
    footer .contacts{display:flex;justify-content:center;align-items:center;gap:20px;margin-bottom:20px;flex-wrap:wrap;text-align:center;}
    footer .contacts a{font-weight:500;background:#222;padding:10px 15px;border-radius:6px;transition:.3s;}
    footer .contacts a:hover{background:#ffcc00;color:#000;}

    /* ===== Modal (NEW transitions) ===== */
    .modal{
      position:fixed;inset:0;z-index:2000;padding-top:60px;overflow:auto;
      background-color:rgba(0,0,0,0.8);
      opacity:0;visibility:hidden;pointer-events:none;
      transition:opacity var(--modal-fade) ease, visibility 0s linear var(--modal-fade);
      -webkit-overflow-scrolling: touch;
    }
    .modal.open{
      opacity:1;visibility:visible;pointer-events:auto;
      transition:opacity var(--modal-fade) ease, visibility 0s;
    }
    .modal-content{
      background-color:#2a2a2a;margin:auto;padding:20px;border-radius:12px;width:90%;max-width:700px;position:relative;
      text-align:center;box-shadow:0 0 25px rgba(0,0,0,0.4);
      transform:scale(0.96);opacity:0;
      transition:opacity var(--modal-scale) ease, transform var(--modal-scale) ease;
      will-change: opacity, transform;
    }
    .modal.open .modal-content{transform:scale(1);opacity:1;}

    .close{color:#fff;position:absolute;top:10px;right:20px;font-size:28px;cursor:pointer;transition:0.2s;z-index:3001;-webkit-tap-highlight-color: transparent;}
    .close:hover{color:#ffcc00;}

    .carousel{position:relative;}
    .carousel img{width:100%;border-radius:8px;margin-bottom:10px;opacity:0;transition:opacity 0.4s ease;}
    .carousel img.loaded{opacity:1;}
    .loader{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2990;pointer-events:none;}
    .dot{display:inline-block;width:10px;height:10px;margin:0 3px;background:#ffcc00;border-radius:50%;animation:bounce 1s infinite ease-in-out;}
    .dot:nth-child(2){animation-delay:0.2s;} .dot:nth-child(3){animation-delay:0.4s;}
    @keyframes bounce{0%,80%,100%{transform:scale(0);}40%{transform:scale(1);}}

    .prev,.next{
      cursor:pointer;position:absolute;top:50%;transform:translateY(-50%) scale(1);
      font-size:42px;color:white;background:none;border:none;opacity:.8;
      transition:transform .2s ease,opacity .2s ease;z-index:3000;user-select:none;outline:none;
      -webkit-appearance:none;-webkit-tap-highlight-color:transparent;border-radius:0;box-shadow:none;
    }
    .prev:hover,.next:hover,.prev:active,.next:active{opacity:1;transform:translateY(-50%) scale(1.3);}
    .prev{left:15px;} .next{right:15px;}

    /* ===== Rent form ===== */
    .rent-tabs{display:flex;justify-content:center;gap:8px;margin:8px 0 14px;}
    .rent-tab{padding:8px 14px;border-radius:6px;border:1px solid #444;background:#222;color:#fff;cursor:pointer;transition:.2s;}
    .rent-tab.active{background:#ffcc00;color:#222;border-color:#ffcc00;font-weight:700;}

    .rent-fields{display:none;flex-direction:column;align-items:center;margin-bottom:10px;}
    .rent-fields.active{display:flex;}
    .rent-fields label{margin-bottom:6px;font-weight:700;color:#ddd;}
    .rent-fields .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
    .rent-fields input[type="date"], .rent-fields select{
      padding:8px 10px;border-radius:6px;border:1px solid #555;outline:none;background:#fff;color:#000;min-width:160px;
      transition:border-color .15s ease;
    }
    #monthlyMonths{min-width:90px; max-width:110px; text-align:center; font-weight:700;}

    .rent-fields input.invalid, .rent-fields select.invalid{border:2px solid var(--danger);}

    .cost-box{display:none;background:#1f1f1f;border:1px dashed #444;border-radius:8px;padding:10px 12px;margin:8px auto 12px;max-width:480px;text-align:left;}
    .cost-line{display:flex;justify-content:space-between;margin:2px 0;}
    .cost-total{font-weight:800;font-size:1.05rem;}
    .cost-duration{font-size:.95rem;color:#ddd;margin-top:6px;text-align:right;}
    .cost-end{font-size:.95rem;color:#ddd;margin-top:2px;text-align:right;}

    .request-label{margin-top:6px;margin-bottom:6px;color:#ccc;font-weight:700;}
    .contact-row{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-top:0;}

    .circle-btn{
      width:52px;height:52px;border-radius:50%;
      background:#fff;display:flex;justify-content:center;align-items:center;
      transition:.2s; box-shadow:0 2px 6px rgba(0,0,0,.25);
    }
    .circle-btn:hover{background:#ffcc00;}
    .circle-btn img{width:28px;height:28px;object-fit:contain;}

    /* Mobile adjustments */
    @media (max-width:768px){
      header{padding-right:96px;}
      #main-logo{height:60px;}
      .hero{min-height:52vh;padding:80px 14px 38px;}
      .hero h1{font-size:1.8rem;}
      .hero .subtitle{font-size:1rem;}
      .hero .subtext{font-size:.95rem;}
      .hero .note{font-size:.9rem;}
      .cta{gap:12px;}
      .cta a{padding:10px 16px;}
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header id="top-header">
    <img id="main-logo" src="https://github.com/truecarsae/truecars-site/blob/truecarsae-images/Truecars.ae.png?raw=true" alt="Truecars Logo">
    <div id="lang-switch" role="group" aria-label="Language switch">
      <button class="lang-btn active" data-lang="en" id="btnEN">EN</button>
      <span class="sep">|</span>
      <button class="lang-btn" data-lang="ru" id="btnRU">RU</button>
    </div>
  </header>
  <div id="header-spacer"></div>

  <!-- Hero -->
  <section class="hero">
    <h1 data-i18n="heroH1">FULL INSURANCE INCLUDED</h1>
    <p class="subtitle" data-i18n="heroH2a">New cars. Top trims. The most comfortable experience.</p>
    <p class="subtext" data-i18n="heroH2b">DELIVERY — FREE!</p>
    <p class="note" data-i18n="heroP2">Across all Dubai, including airports</p>
    <div class="cta">
      <a href="https://wa.me/971506402718" target="_blank" rel="noopener">WhatsApp</a>
      <a href="https://t.me/truecars_ae" target="_blank" rel="noopener">Telegram</a>
      <a href="https://instagram.com/truecars.ae" target="_blank" rel="noopener">Instagram</a>
    </div>
  </section>

  <!-- Cars -->
  <section class="cars">
    <h2 data-i18n="carsTitle">Our Cars</h2>
    <div class="car-grid">
      <div class="car-card">
        <img loading="lazy" decoding="async" src="https://dhihk6wcjzylk.cloudfront.net/carprices/media/catalog/689b185e8aaa1Hyundai_Sonata_Front.webp" alt="Hyundai Sonata 2024">
        <h3>Hyundai Sonata 2024</h3>
        <p class="price" data-en="220 AED / day | 4,300 AED / month" data-ru="220 AED / день | 4,300 AED / месяц">220 AED / day | 4,300 AED / month</p>
      </div>
      <div class="car-card">
        <img loading="lazy" decoding="async" src="https://www.hyundai.com/content/dam/hyundai/wallan/en/data/vehicle-thumbnail/product/azera-2024/small/azera-gn7-3.png" alt="Hyundai Azera 2024">
        <h3>Hyundai Azera 2024</h3>
        <p class="price" data-en="310 AED / day | 6,200 AED / month" data-ru="310 AED / день | 6,200 AED / месяц">310 AED / day | 6,200 AED / month</p>
      </div>
      <div class="car-card">
        <img loading="lazy" decoding="async" src="https://images.dealer.com/ddc/vehicles/2025/Kia/K5/Sedan/perspective/front-left/2025_20.png" alt="Kia K5 2024">
        <h3>Kia K5 2024</h3>
        <p class="price" data-en="200 AED / day | 4,100 AED / month" data-ru="200 AED / день | 4,100 AED / месяц">200 AED / day | 4,100 AED / month</p>
      </div>
      <div class="car-card">
        <img loading="lazy" decoding="async" src="https://cdn.cetas.com.tr/Delivery/Public/Image/-1x-1/308_an2n9mye3c_aids7ir3p2.png" alt="Peugeot 308 2023">
        <h3>Peugeot 308 2023</h3>
        <p class="price" data-en="170 AED / day | 2,700 AED / month" data-ru="170 AED / день | 2,700 AED / месяц">170 AED / day | 2,700 AED / month</p>
      </div>
      <div class="car-card">
        <img loading="lazy" decoding="async" src="https://www.airportchevy.com/blogs/3573/wp-content/uploads/2023/11/2024-chevy-trax.png" alt="Chevrolet Trax 2023">
        <h3>Chevrolet Trax 2023</h3>
        <p class="price" data-en="170 AED / day | 2'700 AED / month" data-ru="170 AED / день | 2'700 AED / месяц">170 AED / day | 2'700 AED / month</p>
      </div>
      <div class="car-card">
        <img loading="lazy" decoding="async" src="https://media.dealeralchemist.com/jellies/Hyundai/Palisade/C475975_WC9_Front.png?auto=compress%2Cformat" alt="Hyundai Palisade 2025">
        <h3>Hyundai Palisade 2025</h3>
        <p class="price" data-en="700 AED / day | 12'000 AED / month" data-ru="700 AED / день | 12'000 AED / месяц">700 AED / day | 12'000 AED / month</p>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="contacts">
      <a href="https://wa.me/971506402718" target="_blank" rel="noopener">WhatsApp</a>
      <a id="footerTelegram" href="https://t.me/truecars_ae" target="_blank" rel="noopener">Telegram</a>
      <a href="https://instagram.com/truecars.ae" target="_blank" rel="noopener">Instagram</a>
    </div>
    <p>&copy; 2025 Truecars.ae - <span data-i18n="rights">All rights reserved.</span></p>
    <p>TRUECARS MIDDLE EAST CAR RENTAL L.L.C.</p>
  </footer>

  <!-- Modal -->
  <div id="carModal" class="modal" aria-modal="true" role="dialog" aria-hidden="true">
    <div class="modal-content" role="document">
      <span class="close" role="button" aria-label="Close">&times;</span>
      <div class="carousel">
        <button class="prev" aria-label="Previous">&#10094;</button>
        <img id="modalImage" src="" alt="Car image">
        <div class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <button class="next" aria-label="Next">&#10095;</button>
      </div>
      <h2 id="carTitle"></h2>

      <!-- Rent tabs -->
      <div class="rent-tabs">
        <button class="rent-tab active" data-mode="daily" id="tabDaily" data-i18n="tabDaily">Daily</button>
        <button class="rent-tab" data-mode="monthly" id="tabMonthly" data-i18n="tabMonthly">Monthly</button>
      </div>

      <!-- DAILY -->
      <div class="rent-fields active" id="fieldsDaily">
        <label data-i18n="noteDaily">Select rental dates</label>
        <div class="row">
          <input type="date" id="dailyStart" min="">
          <input type="date" id="dailyEnd">
        </div>
      </div>

      <!-- MONTHLY -->
      <div class="rent-fields" id="fieldsMonthly">
        <label data-i18n="noteMonthly">Select start date and months</label>
        <div class="row">
          <input type="date" id="monthlyStart">
          <select id="monthlyMonths">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
            <option value="7">7</option><option value="8">8</option><option value="9">9</option>
            <option value="10">10</option><option value="11">11</option><option value="12">12</option>
          </select>
        </div>
      </div>

      <!-- Cost -->
      <div class="cost-box" id="costBox">
        <div class="cost-line"><span data-i18n="labelBase">Base price:</span> <strong id="costBase">—</strong></div>
        <div class="cost-line"><span data-i18n="labelVat">VAT (5%):</span> <strong id="costVat">—</strong></div>
        <div class="cost-line cost-total"><span data-i18n="labelTotal">Total:</span> <strong id="costTotal">—</strong></div>
        <div class="cost-duration" id="costDuration"></div>
        <div class="cost-end" id="costEnd"></div>
      </div>

      <div class="request-label" data-i18n="request">Request:</div>
      <div class="contact-row">
        <a id="whatsappLink" class="circle-btn" target="_blank" rel="noopener" aria-label="WhatsApp">
          <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="">
        </a>
        <a id="telegramLink" class="circle-btn" target="_blank" rel="noopener" aria-label="Telegram">
          <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="">
        </a>
      </div>
    </div>
  </div>

  <script>
    /* ===== Конфиг ===== */
    const TELEGRAM_USERNAME = "truecars_ae";

    /* ===== Header & Parallax ===== */
    const header = document.getElementById('top-header');
    const spacer = document.getElementById('header-spacer');
    header.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
    function syncSpacer(){ spacer.style.height = header.offsetHeight + 'px'; }
    function onScroll(){
      header.classList.toggle('scrolled', window.scrollY > 60);
      syncSpacer();
      const y = Math.min(window.scrollY * 0.35, 250);
      document.documentElement.style.setProperty('--bg-shift', `-${y}px`);
    }
    window.addEventListener('scroll', onScroll);
    window.addEventListener('resize', syncSpacer);
    window.addEventListener('load', () => { syncSpacer(); onScroll(); });

    /* ===== Utils ===== */
    function headWithTimeout(url, timeoutMs=2500){
      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), timeoutMs);
      return fetch(url, {method:'HEAD', signal: controller.signal})
        .then(r => { clearTimeout(t); return r; })
        .catch(() => { clearTimeout(t); return { ok:false }; });
    }
    function toYMD(d){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function fmt(dateStr){
      const d = new Date(dateStr);
      if (isNaN(d)) return '';
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}.${mm}.${yy}`;
    }
    function addMonths(dateStr, months){
      const d = new Date(dateStr);
      if (isNaN(d)) return null;
      const day = d.getDate();
      d.setMonth(d.getMonth() + months);
      while (d.getDate() < day){ d.setDate(d.getDate()-1); }
      return d;
    }
    function daysInclusive(startStr, endStr){
      const s = new Date(startStr), e = new Date(endStr);
      if (isNaN(s) || isNaN(e)) return 0;
      const diff = Math.round((e - s)/(1000*60*60*24));
      return diff < 0 ? 0 : (diff + 1);
    }
    const fmtAED = n => new Intl.NumberFormat('en-US').format(Math.round(n));

    /* ===== Modal & Gallery ===== */
    const modal = document.getElementById("carModal"),
          modalImg = document.getElementById("modalImage"),
          carTitle = document.getElementById("carTitle"),
          closeBtn = document.querySelector(".close"),
          prevBtn = document.querySelector(".prev"),
          nextBtn = document.querySelector(".next"),
          loader = document.querySelector(".loader");

    const tabDaily = document.getElementById('tabDaily');
    const tabMonthly = document.getElementById('tabMonthly');
    const fieldsDaily = document.getElementById('fieldsDaily');
    const fieldsMonthly = document.getElementById('fieldsMonthly');
    const dailyStart = document.getElementById('dailyStart');
    const dailyEnd = document.getElementById('dailyEnd');
    const monthlyStart = document.getElementById('monthlyStart');
    const monthlyMonths = document.getElementById('monthlyMonths');

    const costBox = document.getElementById('costBox');
    const costBaseEl = document.getElementById('costBase');
    const costVatEl = document.getElementById('costVat');
    const costTotalEl = document.getElementById('costTotal');
    const costDurationEl = document.getElementById('costDuration');
    const costEndEl = document.getElementById('costEnd');

    const whatsappLink = document.getElementById('whatsappLink');
    const telegramLink = document.getElementById('telegramLink');
    const footerTelegram = document.getElementById('footerTelegram');

    let currentImages = [], currentIndex = 0, selectedCar = "";
    const imageCache = {}; // cache by slug
    let rentMode = 'daily';
    let currentDailyPrice = 0, currentMonthlyPrice = 0;

    /* ===== i18n ===== */
    const translations = {
      en: {
        heroH1: "FULL INSURANCE INCLUDED",
        heroH2a: "New cars. Top trims. The most comfortable experience.",
        heroP1: "We are honest car rental in Dubai with no deposit",
        heroH2b: "DELIVERY — FREE!",
        heroP2: "Across all Dubai, including airports",
        carsTitle: "Our Cars",
        rights: "All rights reserved.",
        tabDaily: "Daily",
        tabMonthly: "Monthly",
        noteDaily: "Select rental dates",
        noteMonthly: "Select start date and months",
        labelBase: "Base price:",
        labelVat: "VAT (5%):",
        labelTotal: "Total:",
        request: "Request:",
        durationDays: d => `Duration: ${d} day${d>1?'s':''}`,
        durationMonths: m => `Duration: ${m} month${m>1?'s':''}`,
        endDate: date => `End date: ${date}`,
        greeting: "Hi, TrueCars team!",
        askAvail: "Is the car available?",
        msgDaily: (model, d, s, e) => `Hi, TrueCars team! I would like to rent ${model} for ${d} day${d>1?'s':''} (from ${s} to ${e}). Is the car available?`,
        msgMonthly: (model, m, s) => `Hi, TrueCars team! I would like to rent ${model} for ${m} month${m>1?'s':''} (starting from ${s}). Is the car available?`
      },
      ru: {
        heroH1: "ПОЛНАЯ СТРАХОВКА ВКЛЮЧЕНА",
        heroH2a: "Новые автомобили. Богатые комплектации. Максимальный комфорт.",
        heroP1: "Честный прокат авто в Дубае без залога",
        heroH2b: "ДОСТАВКА — БЕСПЛАТНО!",
        heroP2: "По всему Дубаю, включая аэропорты",
        carsTitle: "Наши автомобили",
        rights: "Все права защищены.",
        tabDaily: "День",
        tabMonthly: "Месяц",
        noteDaily: "Выберите даты аренды",
        noteMonthly: "Выберите дату начала и срок аренды (в месяцах)",
        labelBase: "Базовая стоимость:",
        labelVat: "НДС (5%):",
        labelTotal: "Итого:",
        request: "Запрос:",
        durationDays: d => `Аренда на ${d} дн.`,
        durationMonths: m => `Аренда на ${m} мес.`,
        endDate: date => `Окончание аренды: ${date}`,
        greeting: "Здравствуйте, команда TrueCars!",
        askAvail: "Подскажите, пожалуйста, доступен ли автомобиль?",
        msgDaily: (model, d, s, e) => `Здравствуйте, команда TrueCars! Хочу арендовать ${model} на ${d} дн. (с ${s} по ${e}). Подскажите, пожалуйста, доступен ли автомобиль?`,
        msgMonthly: (model, m, s) => `Здравствуйте, команда TrueCars! Хочу арендовать ${model} на ${m} мес. (начиная с ${s}). Подскажите, пожалуйста, доступен ли автомобиль?`
      }
    };

    const i18nSelectors = [
      "heroH1","heroH2a","heroP1","heroH2b","heroP2",
      "carsTitle","rights","tabDaily","tabMonthly","noteDaily","noteMonthly",
      "labelBase","labelVat","labelTotal","request"
    ];

    const btnEN = document.getElementById('btnEN');
    const btnRU = document.getElementById('btnRU');
    const rootHtml = document.documentElement;

    function applyTranslations(lang){
      i18nSelectors.forEach(key=>{
        document.querySelectorAll(`[data-i18n="${key}"]`).forEach(el=>{
          el.textContent = translations[lang][key];
        });
      });
      document.querySelectorAll('.price').forEach(p=>{
        const txt = p.getAttribute(`data-${lang}`);
        if (txt) p.textContent = txt;
      });
      btnEN.classList.toggle('active', lang==='en');
      btnRU.classList.toggle('active', lang==='ru');
      rootHtml.setAttribute('lang', lang);
      rootHtml.setAttribute('data-lang', lang);
      recalc();
      updateLinks();
    }

    function setLang(lang){ localStorage.setItem('lang', lang); applyTranslations(lang); }
    const savedLang = localStorage.getItem('lang') || 'en';
    setLang(savedLang);
    btnEN.addEventListener('click', (e)=>{ e.stopPropagation(); setLang('en'); });
    btnRU.addEventListener('click', (e)=>{ e.stopPropagation(); setLang('ru'); });

    /* ===== Dates min (no past) ===== */
    function setMinDates(){
      const today = toYMD(new Date());
      [dailyStart, dailyEnd, monthlyStart].forEach(inp => { if(inp) inp.min = today; });
      if (dailyStart.value && dailyEnd.value < dailyStart.value) dailyEnd.value = dailyStart.value;
      if (monthlyStart.value && monthlyStart.value < today) monthlyStart.value = today;
    }
    setMinDates();

    // iOS защитный контроль
    function enforceMinDate(input) {
      const today = new Date(); today.setHours(0,0,0,0);
      input.addEventListener('change', () => {
        const val = new Date(input.value);
        if (val < today) { input.value = ''; alert('You cannot select a date in the past.'); }
      });
    }
    [dailyStart, dailyEnd, monthlyStart].forEach(inp => enforceMinDate(inp));

    [dailyStart,dailyEnd,monthlyStart,monthlyMonths].forEach(inp=>{
      if(!inp) return;
      const handler = ()=> inp.classList.remove('invalid');
      inp.addEventListener('input', handler);
      inp.addEventListener('change', handler);
    });

    /* ===== Tabs & Cost ===== */
    function setMode(mode){
      rentMode = mode;
      tabDaily.classList.toggle('active', mode==='daily');
      tabMonthly.classList.toggle('active', mode==='monthly');
      fieldsDaily.classList.toggle('active', mode==='daily');
      fieldsMonthly.classList.toggle('active', mode==='monthly');
      [dailyStart,dailyEnd,monthlyStart,monthlyMonths].forEach(i=> i && i.classList.remove('invalid'));
      setMinDates();
      hideCost();
      updateLinks();
    }
    tabDaily.addEventListener('click',()=>setMode('daily'));
    tabMonthly.addEventListener('click',()=>setMode('monthly'));

    function showCost(base, durationText, endText){
      const vat = base*0.05;
      const total = base+vat;
      costBaseEl.textContent = fmtAED(base) + ' AED';
      costVatEl.textContent = fmtAED(vat) + ' AED';
      costTotalEl.textContent = fmtAED(total) + ' AED';
      costDurationEl.textContent = durationText || '';
      costEndEl.textContent = endText || '';
      costBox.style.display = 'block';
    }
    function hideCost(){
      costBox.style.display = 'none';
      costBaseEl.textContent = '—';
      costVatEl.textContent = '—';
      costTotalEl.textContent = '—';
      costDurationEl.textContent = '';
      costEndEl.textContent = '';
    }

    function recalc(){
      hideCost();
      const lang = rootHtml.getAttribute('data-lang') || 'en';
      if (rentMode==='daily'){
        if (dailyStart.value) dailyEnd.min = dailyStart.value;
        const s = dailyStart.value, e = dailyEnd.value;
        const d = daysInclusive(s,e);
        if (d>0 && currentDailyPrice>0){
          showCost(d * currentDailyPrice, translations[lang].durationDays(d), "");
        }
      } else {
        const s = monthlyStart.value;
        const m = parseInt(monthlyMonths.value,10);
        if (s && m>0 && currentMonthlyPrice>0){
          const base = m * currentMonthlyPrice;
          const end = addMonths(s, m);
          const endFmt = end ? fmt(toYMD(end)) : "";
          showCost(base, translations[lang].durationMonths(m), endFmt ? translations[lang].endDate(endFmt) : "");
        }
      }
    }
    dailyStart.addEventListener('change', ()=>{ setMinDates(); recalc(); });
    dailyEnd.addEventListener('change', recalc);
    monthlyStart.addEventListener('change', ()=>{ setMinDates(); recalc(); });
    monthlyMonths.addEventListener('change', recalc);

    function validate(){
      let ok = true;
      [dailyStart,dailyEnd,monthlyStart,monthlyMonths].forEach(i=> i && i.classList.remove('invalid'));
      if (rentMode==='daily'){
        if (!dailyStart.value){ dailyStart.classList.add('invalid'); ok=false; }
        if (!dailyEnd.value){ dailyEnd.classList.add('invalid'); ok=false; }
        if (ok && daysInclusive(dailyStart.value,dailyEnd.value)<=0){
          dailyEnd.classList.add('invalid'); ok=false;
        }
      } else {
        if (!monthlyStart.value){ monthlyStart.classList.add('invalid'); ok=false; }
        if (!monthlyMonths.value || parseInt(monthlyMonths.value,10)<=0){
          monthlyMonths.classList.add('invalid'); ok=false;
        }
      }
      return ok;
    }

    function buildTelegramHref(text){
      const encoded = encodeURIComponent(text);
      return `https://t.me/${TELEGRAM_USERNAME}?text=${encoded}`;
    }

    function updateLinks(){
      const lang = rootHtml.getAttribute('data-lang') || 'en';
      let text = "";
      if (rentMode==='daily'){
        const s = fmt(dailyStart.value);
        const e = fmt(dailyEnd.value);
        const d = daysInclusive(dailyStart.value, dailyEnd.value);
        if (s && e && d>0){ text = translations[lang].msgDaily(selectedCar, d, s, e); }
      } else {
        const s = fmt(monthlyStart.value);
        const m = parseInt(monthlyMonths.value,10);
        if (s && m>0){ text = translations[lang].msgMonthly(selectedCar, m, s); }
      }
      if (!text){
        text = `${translations[lang].greeting} ${translations[lang].askAvail}`;
      }
      const encoded = encodeURIComponent(text);
      whatsappLink.href = `https://wa.me/971506402718?text=${encoded}`;
      telegramLink.href = buildTelegramHref(text);
      if (footerTelegram){
        const baseText = `${translations[lang].greeting} ${translations[lang].askAvail}`;
        footerTelegram.href = buildTelegramHref(baseText);
      }
    }

    function handleSend(e){
      if (!validate()){
        e.preventDefault();
        return;
      }
      updateLinks();
      hideCost();
    }
    whatsappLink.addEventListener('click', handleSend);
    telegramLink.addEventListener('click', handleSend);

    function extractPrices(card){
      const text = card.querySelector('p')?.textContent || '';
      const dayMatch = text.match(/([\d,'\s]+)\s*AED\s*\/\s*(day|день)/i);
      const monMatch = text.match(/([\d,'\s]+)\s*AED\s*\/\s*(month|месяц)/i);
      const toNum = s => s ? parseInt(s.replace(/[^0-9]/g,''),10) : 0;
      return { day: toNum(dayMatch?.[1]||''), mon: toNum(monMatch?.[1]||'') };
    }

    /* ===== Modal: robust open/close (no auto-close, no black screen) ===== */
    let isOpening = false;
    let isClosing = false;
    let forceTimer = null;

    function resetModalStateHard(){
      // Полный reset DOM-состояния перед открытием — ключ к iOS-устойчивости
      modal.classList.remove('open');
      modal.style.opacity = '0';
      modal.style.visibility = 'hidden';
      modal.setAttribute('aria-hidden','true');
      document.body.classList.remove('no-scroll');
      if (forceTimer){ clearTimeout(forceTimer); forceTimer = null; }
      // Сброс изображения/лоадера
      loader.style.display = 'none';
      modalImg.classList.remove('loaded');
      modalImg.removeAttribute('src');
    }

    function openModal(){
      if (isOpening) return;
      isOpening = true;
      isClosing = false;
      if (forceTimer){ clearTimeout(forceTimer); forceTimer = null; }

      // Жёсткий reset и reflow (важно для повторных открытий на iOS)
      resetModalStateHard();
      void modal.offsetHeight; // reflow

      modal.classList.add('open');
      modal.style.opacity = ''; // вернём под управление CSS
      modal.style.visibility = '';
      modal.setAttribute('aria-hidden','false');
      document.body.classList.add('no-scroll');

      // Снятие флага после окончания transition
      setTimeout(()=>{ isOpening = false; }, 320);
    }

    function closeModal(){
      if (isClosing) return;
      isClosing = true;
      isOpening = false;
      if (!modal.classList.contains('open')){ isClosing = false; return; }

      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      // Фоллбек-таймер (если transitionend не пришёл)
      if (forceTimer){ clearTimeout(forceTimer); }
      forceTimer = setTimeout(()=>{
        resetModalStateHard();
        isClosing = false;
        forceTimer = null;
      }, 360);

      // По завершению плавно обнулим всё
      modal.addEventListener('transitionend', function onEnd(e){
        if (e.target !== modal) return;
        resetModalStateHard();
        isClosing = false;
        modal.removeEventListener('transitionend', onEnd);
      }, { once: true });
    }

    closeBtn.addEventListener("click",(e)=>{ e.stopPropagation(); closeModal(); });
    modal.addEventListener("click",(e)=>{ if (e.target === modal) closeModal(); });
    document.addEventListener("keydown",(e)=>{ if (e.key === "Escape" && modal.classList.contains('open')) closeModal(); });

    /* ===== Image show & controls ===== */
    function showImage(){
      loader.style.display = "block";
      modalImg.classList.remove("loaded");
      // Снимаем прежний onload (если был)
      const img = new Image();
      img.onload = () => {
        modalImg.src = img.src;
        modalImg.classList.add("loaded");
        loader.style.display = "none";
      };
      img.onerror = () => {
        loader.style.display = "none";
      };
      img.src = currentImages[currentIndex];
    }

    prevBtn.addEventListener("click",(e)=>{ e.stopPropagation(); currentIndex=(currentIndex-1+currentImages.length)%currentImages.length; showImage(); });
    nextBtn.addEventListener("click",(e)=>{ e.stopPropagation(); currentIndex=(currentIndex+1)%currentImages.length; showImage(); });

    // Mobile swipes
    let startX=0,endX=0;
    modalImg.addEventListener("touchstart",e=>{startX=e.touches[0].clientX;},{passive:true});
    modalImg.addEventListener("touchmove",e=>{endX=e.touches[0].clientX;},{passive:true});
    modalImg.addEventListener("touchend",()=>{
      if(startX-endX>50){ currentIndex=(currentIndex+1)%currentImages.length; showImage(); }
      else if(endX-startX>50){ currentIndex=(currentIndex-1+currentImages.length)%currentImages.length; showImage(); }
      startX=0; endX=0;
    });

    /* ===== Cards click: load images + open modal ===== */
    document.querySelectorAll(".car-card").forEach(card=>{
      card.addEventListener("click", async (e)=>{
        e.stopPropagation();

        selectedCar = card.querySelector("h3").textContent;
        carTitle.textContent = selectedCar;

        const {day, mon} = extractPrices(card);
        currentDailyPrice = day;
        currentMonthlyPrice = mon;

        // reset формы
        setMode('daily');
        dailyStart.value = ''; dailyEnd.value = '';
        monthlyStart.value = ''; monthlyMonths.value = '';
        setMinDates();
        hideCost();
        updateLinks();

        const slug = (selectedCar.toLowerCase().split(" ")[1] || "").replace(/[^a-z0-9\-]/g,'');
        const rawBase = "https://raw.githubusercontent.com/truecarsae/truecars-site/truecarsae-images/cars/" + slug + "/";
        const apiUrl = `https://api.github.com/repos/truecarsae/truecars-site/contents/cars/${slug}?ref=truecarsae-images`;

        let found = [];
        try {
          if (imageCache[slug]) {
            found = imageCache[slug];
          } else {
            const response = await fetch(apiUrl, { headers: { "Accept": "application/vnd.github.v3+json" }});
            if (response.ok) {
              const files = await response.json();
              found = files
                .filter(f => f.name.toLowerCase().endsWith('.png'))
                .map(f => f.download_url)
                .sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}))
                .slice(0,10);
              imageCache[slug] = found;
            } else {
              // fallback 1..10.png
              const MAX = 10, BATCH = 3;
              for (let start = 1; start <= MAX; start += BATCH){
                const batch = [];
                for (let i = start; i < start + BATCH && i <= MAX; i++){
                  const url = `${rawBase}${i}.png`;
                  batch.push(headWithTimeout(url).then(res => res.ok ? url : null));
                }
                const part = await Promise.all(batch);
                found = found.concat(part.filter(Boolean));
              }
              imageCache[slug] = found;
            }
          }
        } catch(err) { console.error('Image list error:', err); }

        currentImages = found.length ? found : [card.querySelector("img").src];
        currentIndex = 0;

        // сначала показываем модалку (для плавности), затем грузим первую картинку
        openModal();
        showImage();
      }, { passive: true });
    });

    /* ===== Init on load ===== */
    window.addEventListener('load', ()=>{
      const lang = localStorage.getItem('lang') || 'en';
      applyTranslations(lang);
      document.querySelectorAll('.car-card img').forEach(img=>{
        if (img.complete) img.classList.add('img-loaded');
        else img.addEventListener('load', ()=>img.classList.add('img-loaded'), {once:true});
      });
    });
  </script>
</body>
</html>

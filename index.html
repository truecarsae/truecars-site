<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>True Cars Only</title>
  <link rel="preconnect" href="https://api.github.com" crossorigin>
  <link rel="preconnect" href="https://raw.githubusercontent.com" crossorigin>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;}
    html{scroll-behavior:smooth;}
    body{background-color:#3a3a3a;color:#fff;line-height:1.6;overflow-x:hidden;}
    body.no-scroll{overflow:hidden;}
    a{text-decoration:none;color:inherit;}

    :root{
      --header-bg:#1e1e1e;
      --header-height:90px;
      --header-height-scrolled:60px;
      --bg-shift:0px;
      --danger:#ff3333;
      --muted:#bbb;
    }

    /* ===== Header ===== */
    header{
      position:fixed;top:0;left:0;width:100%;
      height:var(--header-height);
      background:var(--header-bg);
      display:flex;justify-content:center;align-items:center;
      transition:height .35s ease,box-shadow .35s ease;
      z-index:1000;
      box-shadow:0 2px 8px rgba(0,0,0,0.4);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    header.scrolled{height:var(--header-height-scrolled);}
    #main-logo{
      height:100%; width:auto; padding:0;
      transition:filter .35s ease;
      display:block; -webkit-user-drag:none;
    }
    header.scrolled #main-logo{filter:drop-shadow(0 0 4px rgba(0,0,0,.2));}
    #header-spacer{height:var(--header-height);transition:height .35s ease;}

    /* ===== Hero (parallax) ===== */
    .hero{
      position:relative;min-height:60vh;overflow:hidden;
      display:flex;flex-direction:column;justify-content:flex-end;align-items:center;
      text-align:center;padding:40px 20px 50px;
      background:linear-gradient(to bottom,rgba(0,0,0,0.55),#3a3a3a 75%);
    }
    .hero::before{
      content:"";position:absolute;top:0;left:0;width:100%;height:120%;
      background:url("https://github.com/truecarsae/truecars-site/blob/truecarsae-images/dubai-skyline.png?raw=true") center/cover no-repeat;
      transform:translateY(var(--bg-shift)); will-change:transform; z-index:-1;
    }
    @media (max-height:700px){ .hero::before{height:100%;} }

    .hero h1{font-size:3rem;font-weight:300;letter-spacing:2px;margin-bottom:12px;}
    .hero h2{font-size:1.8rem;margin-bottom:12px;}
    .hero p{font-size:1.2rem;margin-bottom:25px;color:#ddd;}
    .cta{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;align-items:center;text-align:center;margin-top:10px;}
    .cta a{background:#fff;color:#1c1c1c;padding:15px 25px;border-radius:5px;font-weight:600;transition:0.3s;}
    .cta a:hover{background:#ffcc00;color:#818181;}

    /* ===== Cars ===== */
    .cars{padding:60px 20px;max-width:1200px;margin:0 auto;}
    .cars h2{text-align:center;font-size:2.5rem;margin-bottom:40px;}
    .car-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:30px;}
    .car-card{background:#2a2a2a;border-radius:10px;padding:20px;text-align:center;transition:0.3s;cursor:pointer;}
    .car-card:hover{background:#333;transform:translateY(-5px);}
    .car-card img{max-width:100%;border-radius:10px;margin-bottom:15px;object-fit:cover;aspect-ratio:16/9;}
    .car-card h3{font-size:1.5rem;margin-bottom:10px;}
    .car-card p{font-size:1rem;color:#ccc;}

    /* ===== Footer ===== */
    footer{text-align:center;padding:40px 20px;background:#111;color:#aaa;margin-top:40px;}
    footer .contacts{display:flex;justify-content:center;align-items:center;gap:20px;margin-bottom:20px;flex-wrap:wrap;text-align:center;}
    footer .contacts a{font-weight:500;background:#222;padding:10px 15px;border-radius:6px;transition:.3s;}
    footer .contacts a:hover{background:#ffcc00;color:#000;}

    /* ===== Modal ===== */
    .modal{
      display:none;position:fixed;inset:0;z-index:2000;padding-top:60px;overflow:auto;
      background-color:rgba(0,0,0,0.8);
      opacity:0;
    }
    .modal.open{display:block;animation:fadeIn .3s forwards;}
    .modal.closing{animation:fadeOut .25s forwards;}
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    @keyframes fadeOut{from{opacity:1;}to{opacity:0;}}

    .modal-content{
      background-color:#2a2a2a;margin:auto;padding:20px;border-radius:12px;width:90%;max-width:700px;position:relative;
      text-align:center;box-shadow:0 0 25px rgba(0,0,0,0.4);
      transform:scale(0.95);opacity:0;
      animation:modalAppear .35s forwards;
    }
    .modal.open .modal-content{animation:modalAppear .35s forwards;}
    .modal.closing .modal-content{animation:modalDisappear .25s forwards;}
    @keyframes modalAppear{to{transform:scale(1);opacity:1;}}
    @keyframes modalDisappear{from{transform:scale(1);opacity:1;}to{transform:scale(0.96);opacity:0;}}

    .close{color:#fff;position:absolute;top:10px;right:20px;font-size:28px;cursor:pointer;transition:0.2s;z-index:3001;-webkit-tap-highlight-color: transparent;}
    .close:hover{color:#ffcc00;}

    .carousel{position:relative;}
    .carousel img{width:100%;border-radius:8px;margin-bottom:10px;opacity:0;transition:opacity 0.4s ease;}
    .carousel img.loaded{opacity:1;}
    .loader{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2990;pointer-events:none;}
    .dot{display:inline-block;width:10px;height:10px;margin:0 3px;background:#ffcc00;border-radius:50%;animation:bounce 1s infinite ease-in-out;}
    .dot:nth-child(2){animation-delay:0.2s;} .dot:nth-child(3){animation-delay:0.4s;}
    @keyframes bounce{0%,80%,100%{transform:scale(0);}40%{transform:scale(1);}}

    /* Arrows */
    .prev,.next{
      cursor:pointer;position:absolute;top:50%;transform:translateY(-50%) scale(1);
      font-size:42px;color:white;background:none;border:none;opacity:.8;
      transition:transform .2s ease,opacity .2s ease;z-index:3000;user-select:none;outline:none;
      -webkit-appearance:none;-webkit-tap-highlight-color:transparent;border-radius:0;box-shadow:none;
    }
    .prev:hover,.next:hover,.prev:active,.next:active{opacity:1;transform:translateY(-50%) scale(1.3);}
    .prev{left:15px;} .next{right:15px;}

    /* ===== Rent form ===== */
    .rent-tabs{display:flex;justify-content:center;gap:8px;margin:8px 0 14px;}
    .rent-tab{padding:8px 14px;border-radius:6px;border:1px solid #444;background:#222;color:#fff;cursor:pointer;transition:.2s;}
    .rent-tab.active{background:#ffcc00;color:#222;border-color:#ffcc00;font-weight:700;}
    .rent-fields{display:none;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center;margin-bottom:10px;}
    .rent-fields.active{display:flex;}
    .rent-fields input[type="date"], .rent-fields input[type="number"]{
      padding:8px 10px;border-radius:6px;border:1px solid #555;outline:none;background:#fff;color:#000;min-width:160px;
      transition:border-color .15s ease;
    }
    .rent-fields input.invalid{border:2px solid var(--danger);}
    .calc-note{color:var(--muted);font-size:.9rem;margin-bottom:6px;}

    .cost-box{display:none;background:#1f1f1f;border:1px dashed #444;border-radius:8px;padding:10px 12px;margin:8px auto 12px;max-width:480px;text-align:left;}
    .cost-line{display:flex;justify-content:space-between;margin:2px 0;}
    .cost-total{font-weight:800;font-size:1.05rem;}
    .cost-duration{font-size:.95rem;color:#ddd;margin-top:6px;text-align:right;}
    .cost-end{font-size:.95rem;color:#ddd;margin-top:2px;text-align:right;}

    .request-label{margin-top:6px;margin-bottom:6px;color:#ccc;font-weight:700;}
    .contact-row{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-top:0;}
    .contact-row a{background:#fff;color:#000;padding:10px 18px;border-radius:6px;font-weight:700;transition:.2s;}
    .contact-row a:hover{background:#ffcc00;color:#222;}
  </style>
</head>
<body>

  <!-- Header -->
  <header id="top-header">
    <img id="main-logo" src="https://github.com/truecarsae/truecars-site/blob/truecarsae-images/Truecars.ae.png?raw=true" alt="Truecars Logo">
  </header>
  <div id="header-spacer"></div>

  <!-- Hero -->
  <section class="hero">
    <h1>FULL INSURANCE INCLUDED</h1>
    <h2>Low mileage. High trims. Best experience.</h2>
    <p>We are honest car rental in Dubai without deposit</p>
    <h2>DELIVERY - FREE!</h2>
    <p>All around Dubai including airports</p>
    <div class="cta">
      <a href="https://wa.me/971506402718" target="_blank" rel="noopener">WhatsApp</a>
      <a href="https://t.me/+971506402718" target="_blank" rel="noopener">Telegram</a>
      <a href="https://instagram.com/truecars.ae" target="_blank" rel="noopener">Instagram</a>
    </div>
  </section>

  <!-- Cars -->
  <section class="cars">
    <h2>Our Cars</h2>
    <div class="car-grid">
      <div class="car-card">
        <img loading="lazy" decoding="async" src="https://dhihk6wcjzylk.cloudfront.net/carprices/media/catalog/689b185e8aaa1Hyundai_Sonata_Front.webp" alt="Hyundai Sonata 2024">
        <h3>Hyundai Sonata 2024</h3>
        <p>220 AED / day | 4,300 AED / month</p>
      </div>
      <div class="car-card">
        <img loading="lazy" decoding="async" src="https://www.hyundai.com/content/dam/hyundai/wallan/en/data/vehicle-thumbnail/product/azera-2024/small/azera-gn7-3.png" alt="Hyundai Azera 2024">
        <h3>Hyundai Azera 2024</h3>
        <p>310 AED / day | 6,200 AED / month</p>
      </div>
      <div class="car-card">
        <img loading="lazy" decoding="async" src="https://images.dealer.com/ddc/vehicles/2025/Kia/K5/Sedan/perspective/front-left/2025_20.png" alt="Kia K5 2024">
        <h3>Kia K5 2024</h3>
        <p>200 AED / day | 4,100 AED / month</p>
      </div>
      <div class="car-card">
        <img loading="lazy" decoding="async" src="https://cdn.cetas.com.tr/Delivery/Public/Image/-1x-1/308_an2n9mye3c_aids7ir3p2.png" alt="Peugeot 308 2023">
        <h3>Peugeot 308 2023</h3>
        <p>170 AED / day | 2,700 AED / month</p>
      </div>
      <div class="car-card">
        <img loading="lazy" decoding="async" src="https://www.airportchevy.com/blogs/3573/wp-content/uploads/2023/11/2024-chevy-trax.png" alt="Chevrolet Trax 2023">
        <h3>Chevrolet Trax 2023</h3>
        <p>170 AED / day | 2'700 AED / month</p>
      </div>
      <div class="car-card">
        <img loading="lazy" decoding="async" src="https://media.dealeralchemist.com/jellies/Hyundai/Palisade/C475975_WC9_Front.png?auto=compress%2Cformat" alt="Hyundai Palisade 2025">
        <h3>Hyundai Palisade 2025</h3>
        <p>700 AED / day | 12'000 AED / month</p>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="contacts">
      <a href="https://wa.me/971506402718" target="_blank" rel="noopener">WhatsApp</a>
      <a href="https://t.me/+971506402718" target="_blank" rel="noopener">Telegram</a>
      <a href="https://instagram.com/truecars.ae" target="_blank" rel="noopener">Instagram</a>
    </div>
    <p>&copy; 2025 Truecars.ae - All rights reserved.</p>
    <p>TRUECARS MIDDLE EAST CAR RENTAL L.L.C.</p>
  </footer>

  <!-- Modal -->
  <div id="carModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content">
      <span class="close" role="button" aria-label="Close">&times;</span>
      <div class="carousel">
        <button class="prev" aria-label="Previous">&#10094;</button>
        <img id="modalImage" src="" alt="Car image">
        <div class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <button class="next" aria-label="Next">&#10095;</button>
      </div>

      <h2 id="carTitle"></h2>

      <!-- Rent tabs -->
      <div class="rent-tabs">
        <button class="rent-tab active" data-mode="daily" id="tabDaily">Daily</button>
        <button class="rent-tab" data-mode="monthly" id="tabMonthly">Monthly</button>
      </div>

      <!-- DAILY -->
      <div class="rent-fields active" id="fieldsDaily">
        <span class="calc-note">Select start and end dates</span>
        <input type="date" id="dailyStart">
        <input type="date" id="dailyEnd">
      </div>

      <!-- MONTHLY -->
      <div class="rent-fields" id="fieldsMonthly">
        <span class="calc-note">Select start date and months</span>
        <input type="date" id="monthlyStart">
        <input type="number" id="monthlyMonths" min="1" max="24" placeholder="Months">
      </div>

      <!-- Cost -->
      <div class="cost-box" id="costBox">
        <div class="cost-line"><span>Base price:</span> <strong id="costBase">—</strong></div>
        <div class="cost-line"><span>VAT (5%):</span> <strong id="costVat">—</strong></div>
        <div class="cost-line cost-total"><span>Total:</span> <strong id="costTotal">—</strong></div>
        <div class="cost-duration" id="costDuration"></div>
        <div class="cost-end" id="costEnd"></div>
      </div>

      <div class="request-label">Request:</div>
      <div class="contact-row">
        <a id="whatsappLink" target="_blank" rel="noopener">WhatsApp</a>
        <a id="telegramLink" target="_blank" rel="noopener">Telegram</a>
      </div>
    </div>
  </div>

  <script>
    /* ===== Header & Parallax ===== */
    const header = document.getElementById('top-header');
    const spacer = document.getElementById('header-spacer');
    header.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
    function syncSpacer(){ spacer.style.height = header.offsetHeight + 'px'; }
    function onScroll(){
      header.classList.toggle('scrolled', window.scrollY > 60);
      syncSpacer();
      const y = Math.min(window.scrollY * 0.35, 250);
      document.documentElement.style.setProperty('--bg-shift', `-${y}px`);
    }
    window.addEventListener('scroll', onScroll);
    window.addEventListener('resize', syncSpacer);
    window.addEventListener('load', () => { syncSpacer(); onScroll(); });

    /* ===== Utils ===== */
    function headWithTimeout(url, timeoutMs=2500){
      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), timeoutMs);
      return fetch(url, {method:'HEAD', signal: controller.signal})
        .then(r => { clearTimeout(t); return r; })
        .catch(() => { clearTimeout(t); return { ok:false }; });
    }

    // date helpers
    function toYMD(d){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function fmt(dateStr){
      const d = new Date(dateStr);
      if (isNaN(d)) return '';
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}.${mm}.${yy}`;
    }
    function addMonths(dateStr, months){
      const d = new Date(dateStr);
      if (isNaN(d)) return null;
      const day = d.getDate();
      d.setMonth(d.getMonth() + months);
      // корректировка для конца месяца
      while (d.getDate() < day){ d.setDate(d.getDate()-1); }
      return d;
    }
    function daysInclusive(startStr, endStr){
      const s = new Date(startStr), e = new Date(endStr);
      if (isNaN(s) || isNaN(e)) return 0;
      const diff = Math.round((e - s)/(1000*60*60*24));
      return diff < 0 ? 0 : (diff + 1);
    }
    const fmtAED = n => new Intl.NumberFormat('en-US').format(Math.round(n));

    /* ===== Modal & Gallery ===== */
    const modal = document.getElementById("carModal"),
          modalImg = document.getElementById("modalImage"),
          carTitle = document.getElementById("carTitle"),
          closeBtn = document.querySelector(".close"),
          prevBtn = document.querySelector(".prev"),
          nextBtn = document.querySelector(".next"),
          loader = document.querySelector(".loader");

    // Rent elements
    const tabDaily = document.getElementById('tabDaily');
    const tabMonthly = document.getElementById('tabMonthly');
    const fieldsDaily = document.getElementById('fieldsDaily');
    const fieldsMonthly = document.getElementById('fieldsMonthly');
    const dailyStart = document.getElementById('dailyStart');
    const dailyEnd = document.getElementById('dailyEnd');
    const monthlyStart = document.getElementById('monthlyStart');
    const monthlyMonths = document.getElementById('monthlyMonths');

    const costBox = document.getElementById('costBox');
    const costBaseEl = document.getElementById('costBase');
    const costVatEl = document.getElementById('costVat');
    const costTotalEl = document.getElementById('costTotal');
    const costDurationEl = document.getElementById('costDuration');
    const costEndEl = document.getElementById('costEnd');

    const whatsappLink = document.getElementById('whatsappLink');
    const telegramLink = document.getElementById('telegramLink');

    let currentImages = [], currentIndex = 0, selectedCar = "";
    const imageCache = {}; // cache by slug
    let rentMode = 'daily'; // 'daily' | 'monthly'
    let currentDailyPrice = 0, currentMonthlyPrice = 0; // parsed from card

    // set min dates = today
    function setMinDates(){
      const today = toYMD(new Date());
      [dailyStart, dailyEnd, monthlyStart].forEach(inp => { if(inp) inp.min = today; });
    }
    setMinDates();

    // remove invalid border on input
    [dailyStart,dailyEnd,monthlyStart,monthlyMonths].forEach(inp=>{
      if(!inp) return;
      const handler = ()=> inp.classList.remove('invalid');
      inp.addEventListener('input', handler);
      inp.addEventListener('change', handler);
    });

    // tabs
    function setMode(mode){
      rentMode = mode;
      tabDaily.classList.toggle('active', mode==='daily');
      tabMonthly.classList.toggle('active', mode==='monthly');
      fieldsDaily.classList.toggle('active', mode==='daily');
      fieldsMonthly.classList.toggle('active', mode==='monthly');
      [dailyStart,dailyEnd,monthlyStart,monthlyMonths].forEach(i=> i && i.classList.remove('invalid'));
      hideCost();
      updateLinks();
    }
    tabDaily.addEventListener('click',()=>setMode('daily'));
    tabMonthly.addEventListener('click',()=>setMode('monthly'));

    function showCost(base, durationText, endText){
      const vat = base*0.05;
      const total = base+vat;
      costBaseEl.textContent = fmtAED(base) + ' AED';
      costVatEl.textContent = fmtAED(vat) + ' AED';
      costTotalEl.textContent = fmtAED(total) + ' AED';
      costDurationEl.textContent = durationText || '';
      costEndEl.textContent = endText || '';
      costBox.style.display = 'block';
    }
    function hideCost(){
      costBox.style.display = 'none';
      costBaseEl.textContent = '—';
      costVatEl.textContent = '—';
      costTotalEl.textContent = '—';
      costDurationEl.textContent = '';
      costEndEl.textContent = '';
    }

    // recalc in real-time
    function recalc(){
      hideCost();
      if (rentMode==='daily'){
        // keep end >= start
        if (dailyStart.value) dailyEnd.min = dailyStart.value;
        const s = dailyStart.value, e = dailyEnd.value;
        const d = daysInclusive(s,e);
        if (d>0 && currentDailyPrice>0){
          const base = d * currentDailyPrice;
          showCost(base, `Duration: ${d} day${d>1?'s':''}`);
        }
      } else {
        const s = monthlyStart.value;
        const m = parseInt(monthlyMonths.value,10);
        if (s && m>0 && currentMonthlyPrice>0){
          const base = m * currentMonthlyPrice;
          const end = addMonths(s, m);
          const endText = end ? `End date: ${fmt(toYMD(end))}` : '';
          showCost(base, `Duration: ${m} month${m>1?'s':''}`, endText);
        }
      }
    }
    dailyStart.addEventListener('change', recalc);
    dailyEnd.addEventListener('change', recalc);
    monthlyStart.addEventListener('change', recalc);
    monthlyMonths.addEventListener('input', recalc);

    // validation
    function validate(){
      let ok = true;
      [dailyStart,dailyEnd,monthlyStart,monthlyMonths].forEach(i=> i && i.classList.remove('invalid'));
      if (rentMode==='daily'){
        if (!dailyStart.value){ dailyStart.classList.add('invalid'); ok=false; }
        if (!dailyEnd.value){ dailyEnd.classList.add('invalid'); ok=false; }
        if (ok && daysInclusive(dailyStart.value,dailyEnd.value)<=0){
          dailyEnd.classList.add('invalid'); ok=false;
        }
      } else {
        if (!monthlyStart.value){ monthlyStart.classList.add('invalid'); ok=false; }
        if (!monthlyMonths.value || parseInt(monthlyMonths.value,10)<=0){
          monthlyMonths.classList.add('invalid'); ok=false;
        }
      }
      return ok;
    }

    // links (English + greeting + availability)
    function updateLinks(){
      let period = '';
      if (rentMode==='daily'){
        const s = fmt(dailyStart.value);
        const e = fmt(dailyEnd.value);
        const d = daysInclusive(dailyStart.value, dailyEnd.value);
        if (s && e && d>0) period = `for ${d} day${d>1?'s':''} (from ${s} to ${e})`;
      } else {
        const s = fmt(monthlyStart.value);
        const m = parseInt(monthlyMonths.value,10);
        if (s && m>0) period = `for ${m} month${m>1?'s':''} (starting from ${s})`;
      }
      const text = encodeURIComponent(`Hi, TrueCars team! I would like to rent ${selectedCar} ${period}. Is the car available?`);
      whatsappLink.href = `https://wa.me/971506402718?text=${text}`;
      telegramLink.href = `https://t.me/+971506402718?text=${text}`;
    }

    function handleSend(e){
      if (!validate()){
        e.preventDefault();
        return;
      }
      updateLinks();
      hideCost(); // hide after sending
    }
    whatsappLink.addEventListener('click', handleSend);
    telegramLink.addEventListener('click', handleSend);

    // parse prices from card text
    function extractPrices(card){
      const text = card.querySelector('p')?.textContent || '';
      const dayMatch = text.match(/([\d,'\s]+)\s*AED\s*\/\s*day/i);
      const monMatch = text.match(/([\d,'\s]+)\s*AED\s*\/\s*month/i);
      const toNum = s => s ? parseInt(s.replace(/[^0-9]/g,''),10) : 0;
      return { day: toNum(dayMatch?.[1]||''), mon: toNum(monMatch?.[1]||'') };
    }

    /* ===== Gallery: GitHub API + cache + fallback ===== */
    document.querySelectorAll(".car-card").forEach(card=>{
      card.addEventListener("click", async (e)=>{
        e.stopPropagation();
        selectedCar = card.querySelector("h3").textContent;
        carTitle.textContent = selectedCar;

        const {day, mon} = extractPrices(card);
        currentDailyPrice = day;
        currentMonthlyPrice = mon;

        // reset form each open
        setMode('daily');
        dailyStart.value = ''; dailyEnd.value = '';
        monthlyStart.value = ''; monthlyMonths.value = '';
        setMinDates(); // refresh mins (today)
        hideCost();
        updateLinks();

        const slug = (selectedCar.toLowerCase().split(" ")[1] || "").replace(/[^a-z0-9\-]/g,'');
        const rawBase = "https://raw.githubusercontent.com/truecarsae/truecars-site/truecarsae-images/cars/" + slug + "/";
        const apiUrl = `https://api.github.com/repos/truecarsae/truecars-site/contents/cars/${slug}?ref=truecarsae-images`;

        let found = [];
        try {
          if (imageCache[slug]) {
            found = imageCache[slug];
          } else {
            const response = await fetch(apiUrl, { headers: { "Accept": "application/vnd.github.v3+json" }});
            if (response.ok) {
              const files = await response.json();
              found = files
                .filter(f => f.name.toLowerCase().endsWith('.png'))
                .map(f => f.download_url)
                .sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}))
                .slice(0,10);
              imageCache[slug] = found;
            } else {
              // fallback 1..10.png
              const MAX = 10, BATCH = 3;
              for (let start = 1; start <= MAX; start += BATCH){
                const batch = [];
                for (let i = start; i < start + BATCH && i <= MAX; i++){
                  const url = `${rawBase}${i}.png`;
                  batch.push(headWithTimeout(url).then(res => res.ok ? url : null));
                }
                const part = await Promise.all(batch);
                found = found.concat(part.filter(Boolean));
              }
              imageCache[slug] = found;
            }
          }
        } catch(e) {
          console.error('Image list error:', e);
        }

        currentImages = found;
        if (currentImages.length === 0) {
          const cardImg = card.querySelector("img").src;
          currentImages = [cardImg];
        }

        currentIndex = 0;
        showImage();
        openModal();
      });
    });

    /* ===== Modal open/close with fade ===== */
    function openModal(){
      modal.classList.remove('closing');
      modal.classList.add('open');
      modal.style.display = 'block';
      document.body.classList.add('no-scroll');
    }
    function closeModal(){
      if(!modal.classList.contains('open')) return;
      modal.classList.remove('open');
      modal.classList.add('closing');
      const onAnimEnd = ()=> {
        modal.style.display = 'none';
        modal.classList.remove('closing');
        document.body.classList.remove('no-scroll');
        modal.removeEventListener('animationend', onAnimEnd);
      };
      modal.addEventListener('animationend', onAnimEnd);
    }

    closeBtn.addEventListener("click",(e)=>{ e.stopPropagation(); closeModal(); });
    modal.addEventListener("click",(e)=>{ if (e.target === modal) closeModal(); });
    document.addEventListener("keydown",(e)=>{ if (e.key === "Escape" && modal.classList.contains('open')) closeModal(); });

    /* ===== Image show & controls ===== */
    function showImage(){
      loader.style.display = "block";
      modalImg.classList.remove("loaded");
      const img = new Image();
      img.src = currentImages[currentIndex];
      img.onload = () => {
        modalImg.src = img.src;
        modalImg.classList.add("loaded");
        loader.style.display = "none";
      };
    }
    prevBtn.addEventListener("click",(e)=>{ e.stopPropagation(); currentIndex=(currentIndex-1+currentImages.length)%currentImages.length; showImage(); });
    nextBtn.addEventListener("click",(e)=>{ e.stopPropagation(); currentIndex=(currentIndex+1)%currentImages.length; showImage(); });

    // Mobile swipes
    let startX=0,endX=0;
    modalImg.addEventListener("touchstart",e=>{startX=e.touches[0].clientX;},{passive:true});
    modalImg.addEventListener("touchmove",e=>{endX=e.touches[0].clientX;},{passive:true});
    modalImg.addEventListener("touchend",()=>{ if(startX-endX>50){ currentIndex=(currentIndex+1)%currentImages.length; showImage(); }
      else if(endX-startX>50){ currentIndex=(currentIndex-1+currentImages.length)%currentImages.length; showImage(); }
      startX=0; endX=0; });
  </script>
</body>
</html>
